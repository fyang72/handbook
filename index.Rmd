---
title: "An Interactive Handbook for Pharmacometrics Analysis"
author: "Feng Yang"
date: "12/18/2018"
runtime: shiny
output:  
 html_document:
   toc: true
   fig_caption: true
   toc_float:
       collapsed: true
       smooth_scroll: true
   toc_depth: 3
   css: styles.css
   code_folding: show
   number_sections: true
   keep_md: no
pdf_document:
    fig_caption: yes
    keep_tex: yes
    toc: yes
    toc_depth: 3    
---




```{r global, include=FALSE, cache=FALSE}
 
```


```{r, setup, include=FALSE}
# back to [nonmem_dataset_integrity_check](#nonmem_dataset_integrity_check)
# http://www.pmxsolutions.com/2018/08/06/nonmem-model-fitting-as-a-gif-in-r-with-code/
#https://www.pmxsolutions.com/2018/12/10/creating-a-simple-pharmacometric-shiny-application-with-mrgsolve-in-r-part-1/

# Best practices for global/external variables used in a module 
# https://community.rstudio.com/t/best-practices-for-global-external-variables-used-in-a-module/5820/11

# Communication between modules
# https://shiny.rstudio.com/articles/communicate-bet-modules.html

# https://stackoverflow.com/questions/36695577/shiny-module-that-calls-a-reactive-data-set-in-parent-shiny-server

# https://deanattali.com/blog/building-shiny-apps-tutorial/
  


# help from observeEvent()
# shinyApp(
#     ui = basicPage(actionButton("go", "Go")),
#     server = function(input, output, session) {
#       observeEvent(input$go, {
#         insertUI("#go", "afterEnd",
#                  actionButton("dynamic", "click to remove"))
# 
#         # set up an observer that depends on the dynamic
#         # input, so that it doesn't run when the input is
#         # created, and only runs once after that (since
#         # the side effect is remove the input from the DOM)
#         observeEvent(input$dynamic, {
#           removeUI("#dynamic")
#         }, ignoreInit = TRUE, once = TRUE)
#       })
#     }
#   )
# }


library(shiny)
library(ggplot2)


rm(list = ls())

if (1==2) {    
  setwd("~/handbook/")
  source("~/handbook/global.R")
}

```

 
```{r}

ALL <- reactiveValues(
  DATA   = list(), 
  FIGURE = list(), 
  TABLE = list(), 
  cppModel = list(), 
  ctlModel = list(), 
  script = list()
)  
```


```{r }

renderUI({ 
figure = NULL
tdata = data.frame(xvar=1:10, yvar=1:10)
figLn <- ggplot(tdata, aes(x=xvar, y=yvar)) + geom_point() + geom_line()
figLog <- figLn + scale_y_log10()

fig <- figLn
attr(fig, 'title') <- paste0(
  "Mean(±SE) ", " in Serum vs Nominal Sampling Day Following Subcutaneous or Intravenous Dose(s) of ", ")")

attr(fig, 'width') <- 9
attr(fig, 'height') <- 6                                
figure[["pk_mean_profile_ln"]] = fig 
figure[["pk_mean_profile_ln"]]$data =  tdata


fig <- figLog
attr(fig, 'title') <- paste0(
  "Semi-Log Mean(±SE) ", " in Serum vs Nominal Sampling Day Following Subcutaneous or Intravenous Dose(s) of ", ")")

attr(fig, 'width') <- 9
attr(fig, 'height') <- 6                                
figure[["pk_mean_profile_log"]] = fig 
figure[["pk_mean_profile_log"]]$data =  tdata


ALL$FIGURE = figure


tabl = data.frame(x=1, y=1)
attr(tabl, 'title') <-  "tst1"
ALL$TABLE[["TSET1"]] = tabl

tabl = data.frame(x=10, y=10)
attr(tabl, 'title') <-  "tst2"
ALL$TABLE[["TSET2"]] = tabl

tabl = data.frame(x=1, y=1)
attr(tabl, 'title') <-  "tst1"
ALL$DATA[["TSET1"]] = tabl

tabl = data.frame(x=10, y=10)
attr(tabl, 'title') <-  "tst2"
ALL$DATA[["TSET2"]] = tabl

cppModel1=mread(model='cppModel',
               project=paste0(HOME, '/cpp/'),
               quiet=TRUE,
               file=basename("LN001.cpp"))

cppModel2=mread(model='cppModel',
               project=paste0(HOME, '/cpp/'),
               quiet=TRUE,
               file=basename("LN001.cpp"))


ALL$cppModel = list(
  "LN0011.cpp"=cppModel1, 
  "LN0022.cpp"=cppModel2
  ) 
 
ALL$ctlModel = list(
  "LN001.ctl"=readLines(paste0(HOME, "/ctl/", "LN001.ctl")), 
  "LN002.ctl"=readLines(paste0(HOME, "/ctl/", "LN002.ctl"))
  ) 


 ALL$script = list(
  "build_adsl.R"=readLines(paste0(HOME, "/script/", "build_adsl.R")), 
  "build_adex.R"=readLines(paste0(HOME, "/script/", "build_adex.R"))
  )
  
})

```
 

 
```{r, eval=TRUE}
ihandbook = 0

folder.loc <- "~/handbook/util"

file.lst <-list.files(path = folder.loc, all.files = FALSE,full.names = TRUE, include.dirs = TRUE, recursive =TRUE)     

file.lst = file.lst[which(substr(file.lst, nchar(file.lst)-1, nchar(file.lst)) %in% c(".r", ".R"))]

for (ifile in 1:length(file.lst)) { 
  #print(file.lst[ifile]);  
  source(file=file.lst[ifile])  
}     #sys.source('file.R', envir=environment())


folder.loc <- "~/handbook/module/"
file.lst <-list.files(path = folder.loc, all.files = FALSE,full.names = TRUE, include.dirs = TRUE, recursive =TRUE)     
file.lst = file.lst[which(substr(file.lst, nchar(file.lst)-1, nchar(file.lst)) %in% c(".r", ".R"))]

file.lst = file.lst[which(!substr(gsub(folder.loc, "", file.lst, fix=TRUE), 1,1) %in% c("_"))]

for (ifile in 1:length(file.lst)) { 
  #print(file.lst[ifile]);  
  source(file=file.lst[ifile])  
}     #sys.source('file.R', envir=environment())

folder.loc <- "~/handbook/script/"
file.lst <-list.files(path = folder.loc, all.files = FALSE,full.names = TRUE, include.dirs = TRUE, recursive =TRUE)     
file.lst = file.lst[which(substr(file.lst, nchar(file.lst)-1, nchar(file.lst)) %in% c(".r", ".R"))]

file.lst = file.lst[which(!substr(gsub(folder.loc, "", file.lst, fix=TRUE), 1,1) %in% c("_"))]

for (ifile in 1:length(file.lst)) { 
  #print(file.lst[ifile]);  
  source(file=file.lst[ifile])  
}     #sys.source('file.R', envir=environment())

```
 
   
   
 
```{r eval=FALSE}
rmd <- list.files(pattern = '*.Rmd', recursive = T)
chunks <- paste0("```{r child = '", rmd, "'}\n```\n")
cat(chunks, sep = '\n')
```

```{r child = 'rmd/04_descriptive_analysis/01_load_dataset.Rmd'}
```

```{r child = 'rmd/04_descriptive_analysis/03_pkpd_relationship.Rmd'}
```

```{r child = 'rmd/08_run_simulation/50_run_sim.Rmd'}
```


```{r child = 'rmd/11_reporting/01_reporting.Rmd'}
```
 
 




 