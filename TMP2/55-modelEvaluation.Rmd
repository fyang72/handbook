---
title: "Untitled"
author: "Feng Yang"
date: "December 8, 2017"
output: word_document
---

```{r load-BST-params, eval=TRUE}
  # PARAMS1000
  load(file="./data/PARAMS1000.Rdata")

```

## \@ref(result-final-model-evaluation) Model Evaluation (to be finished) {#result-final-model-evaluation}

 
### \@ref(result-final-model-stability) Model Stability  {#result-final-model-stability}

 
The final model was fitted to 1,000 bootstrap replicate datasets to evaluate its stability and performance. Nonparametric bootstrap was performed and resulted in 95% CIs for population PK parameter estimates, which are presented in Table  \@ref(tab:model-evaluaion-bootstrap). CIs were based on bootstrap estimates from 1,000 model runs that converged successfully, regardless of $COVARIANCE step success. Among the 1,000 runs, 23 (2.3%) had a failed covariance step due to rounding errors. 

Overall, typical structural model parameters, random variance terms, and covariate effects were estimated with good precision.  The difference in parameter estimates between the original NONMEMÂ® input dataset and the bootstrapped datasets were minimal (less than 10%), indicating good stability of the final model. Histogram figures of the OFV and parameter estimates across the 1000 runs that converged successfully are shown in Appendix  \@ref(sec-appendix-D). 
 
 
 
```{r manual-model-evaluaion-bootstrap, eval=FALSE}

library(data.table)
adpx = read.csv(file=paste0("./data/", "nmdat_1218A_2017.csv")) 
adpx = adpx %>% filter(C==".") # after remove outliers
tdata <- as.data.table(adpx)
setkey(tdata, "ID")


MODEL.HOME <- "H:\\FYANG\\R2810_PD1\\MODEL\\"
final.model.runno = c("LN900")

directory = paste0(MODEL.HOME, "ctl\\HPC\\")
base_ctl = readLines(paste0(directory,  final.model.runno, ".ctl"),warn=FALSE) 


n.sample= 1000
for (i in 1:n.sample)  {
  
  print(i)
  ID.1423.1mkg = unique(adpx%>%filter(STDY==1423, ARMA=="1-mg/kg-Q2W")%>%pull(ID))
  ID.1423.3mkgQ2W = unique(adpx%>%filter(STDY==1423, ARMA=="3-mg/kg-Q2W")%>%pull(ID))
  ID.1423.3mkgQ3W = unique(adpx%>%filter(STDY==1423, ARMA=="3-mg/kg-Q3W")%>%pull(ID))
  ID.1423.10mkg = unique(adpx%>%filter(STDY==1423, ARMA=="10-mg/kg-Q2W")%>%pull(ID))
  ID.1423.200mg = unique(adpx%>%filter(STDY==1423, ARMA=="200-mg-Q2W")%>%pull(ID))
   
  ID.1540 = unique(adpx%>%filter(STDY==1540)%>%pull(ID))
  #length( c(ID.1423.1mkg, ID.1423.3mkgQ2W , ID.1423.3mkgQ3W ,  ID.1423.10mkg , ID.1423.200mg, ID.1540))
  
  sampled.IDs <- c(sample(ID.1423.1mkg, length(ID.1423.1mkg), replace = TRUE), 
                   sample(ID.1423.3mkgQ2W, length(ID.1423.3mkgQ2W), replace = TRUE), 
                   sample(ID.1423.3mkgQ3W, length(ID.1423.3mkgQ3W), replace = TRUE), 
                   sample(ID.1423.10mkg, length(ID.1423.10mkg), replace = TRUE), 
                   sample(ID.1423.200mg, length(ID.1423.200mg), replace = TRUE), 
                   sample(ID.1540, length(ID.1540), replace = TRUE))
  #length(sampled.IDs)
  # create the new data set
  dat_new <- tdata[J(sampled.IDs), allow.cartesian = TRUE]
  
  dat_new <- dat_new %>% mutate(TIME=as_numeric(TIME)) %>% 
                   mutate(newID=ifelse(TIME==0, 1, 0)) %>% 
                   mutate(newID=cumsum(newID))
  dat_new$ID = dat_new$newID
  dat_new = dat_new %>% select(-newID)
  #length(unique(dat_new$ID))
   
  ctl = gsub("../../data/nmdat_1218A_2017", paste0("nmdat_", i), base_ctl, fix=TRUE)
  
  
  write_csv(dat_new, paste0(paste0(MODEL.HOME, "ctl\\BST\\"), "nmdat_", i, ".csv"))
  writeLines(ctl, paste0(paste0(MODEL.HOME, "ctl\\BST\\"), "LN", i, ".ctl")) 


}

 
# start  "LN001"  nmgo.bat  LN001.ctl   
# start  "LN002"  nmgo.bat  LN002.ctl   
 




# use HPC to run 
#--------------------
  
file.lst = paste0("LN", add_prefix(seq(1, 1000, by=1), digits=4), ".ctl")
file.lst

directory = paste0(MODEL.HOME, "ctl\\BST2\\")
base_ctl = readLines(paste0(directory,  "LN0000.ctl"),warn=FALSE) 

for (i in 1:length(file.lst)) { 
    file = file.lst[i]
    print(file)
     
    ctl = gsub("../../data/nmdat.csv", paste0("../nmdat_", i, ".csv"), base_ctl, fix=TRUE)
    writeLines(ctl, paste0(paste0(MODEL.HOME, "ctl\\BST2\\"),  file)) 

}

 

# write a batch file, run on HPC
batch.run.lst = NULL
for (ifile in 1:length(file.lst)) { 
  file.name = file.lst[ifile]
  batch.run.lst = c(batch.run.lst, paste0("./run.sh  ", gsub(".ctl", "", file.name, fix=TRUE), "   1"))

} 
 
 folder.loc = paste0(MODEL.HOME, "ctl\\BST2\\")
 writeLines(batch.run.lst, paste0(folder.loc, "run.BST.HPC.txt"))  
  
  
  
```



```{r  read-bootstrap-from-BST2, eval=FALSE }
 
  
  runno.lst = paste0("LN", add_prefix(seq(1, 1000, by=1), digits=4) )
  #runno.lst = paste0("LN", seq(1, 1000, by=1)) 
  PARAMS = read_PARAMS(MODEL.HOME="H:\\FYANG\\R2810_PD1\\MODEL\\", subdir="/ctl/BST2/", runno.lst)
  out = merge_all(PARAMS)    
  
  out$model = rownames(out)
  PARAMS1000 = out
  save(PARAMS1000, file="./data/PARAMS1000.Rdata")
  
  
  # run those unsuccesful ones
  unsuccesful.model.lst = setdiff(runno.lst, PARAMS1000 %>% filter(minimization_successful==1) %>% pull(model))
  length(unsuccesful.model.lst)
  
  rounding_errors.model.lst = setdiff(unsuccesful.model.lst, PARAMS1000 %>% filter(rounding_errors==1) %>% pull(model))
  length(rounding_errors.model.lst)
  
  
  
  length(setdiff(runno.lst, PARAMS1000  %>% pull(model)))
  
  sum(PARAMS1000$estimate_near_boundary)
  sum(PARAMS1000$rounding_errors) 
  sum(PARAMS1000$zero_gradients) 
  sum(PARAMS1000$final_zero_gradients) 
  sum(PARAMS1000$hessian_reset) 
  sum(PARAMS1000$s_matrix_singular)
  
  
  runno.lst =  rounding_errors.model.lst
  out = NULL   
  for (i in 1:length(runno.lst)) { 
  runno = runno.lst[i]
  out = c(out, paste0("./run.sh  ", runno, "   1"))
  
  }
  out
  
  folder.loc <- paste0("H:\\FYANG\\R2810_PD1\\MODEL\\ctl\\BST2\\")
  writeLines(out, paste0(folder.loc, "run.batch70.txt"))  

 

```





```{r  read-bootstrap-from-WFN, eval=FALSE }

  OUT = NULL
 
    
for (i in 1:1000) {  
  runno = paste0("LN", i) 
  print(runno)
  
  YN=0
  model.lst = readLST(runno)  # read.lst(paste(MODEL.HOME, "ctl/BST/", runno, ".NM7\\", runno, ".lst", sep="")  )
  if (!is.null(model.lst)) { 
    YN = ifelse(model.lst$term[1]=="MINIMIZATION SUCCESSFUL", 1, 0)
    ofv = model.lst$ofv
    thetas = model.lst$thetas %>% unlist()  
    omega = model.lst$omega %>% unlist()
    omega = omega[omega!=0]
  }else{
    YN = 0; 
    ofv=0
    thetas=rep(0, length(thetas))
    omega=rep(0, length(omega))
  }
  params = c(runno, YN, ofv, thetas, omega)     
  OUT = rbind(OUT, params)
}

OUT_BST = OUT
save(OUT_BST, file= "./data/OUT_BST.Rdata")


  OUT1= OUT%>%as.data.frame() %>% mutate(V2=as_numeric(V2)) %>% filter(V2>-10, !is.na(V2))
  YN = OUT1$V2 
  sum(YN)/length(YN)

```





```{r model-evaluaion-bootstrap}
library(dplyr)
#  
# runno.lst = final.model.runno
# 
# subdir="/ctl/HPC/"
# file.name=paste0(MODEL.HOME, subdir, runno.lst, "BST/", "bootstrap_dir1/raw_results_", runno.lst, ".csv")
# tdata = read_csv(file.name)  %>% as.data.frame() 
# colnames(tdata) = gsub("OMEGA(2,1)", "OMEGA.2.1.", colnames(tdata), fix=TRUE)
# 
# PARAMS=NULL
# PARAMS[[1]]=tdata%>% filter(model==0)
# names(PARAMS) = runno.lst
# output_params = get_summary_params(PARAMS, runno.lst)
# 
# param.lst = tdata %>% select(dplyr::starts_with("TV", ignore.case=FALSE), EMAX, T50, HILL, RUVCV, RUVSD, OMEGA.2.1.,  # one_of("OMEGA(2,1)"), 
#                  dplyr::contains("_ON_"), 
#                  dplyr::starts_with("IIV_"), 
#                  -dplyr::starts_with("se")
# )  %>% colnames()
#  
# tdata = tdata %>% gather(params, value, -model)
# tdata = tdata %>% filter(params %in% param.lst)  %>% mutate(value=as_numeric(value))
# 
# tdata =  tdata  %>% group_by(params) %>%
#   summarise(n=n(), 
#             `2.5%`=quantile(value, probs=0.025),
#             `5%`=quantile(value, probs=0.05),
#             `25%`=quantile(value, probs=0.25),
#             `50%`=quantile(value, probs=0.5),
#             `75%`=quantile(value, probs=0.75),
#             `95%`=quantile(value, probs=0.95),
#             `97.5%`=quantile(value, probs=0.975),
#             Mean=mean(value, na.rm=TRUE), 
#             Median=median(value, na.rm=TRUE)
#             )
#  
# output_params = output_params %>% mutate(params=rownames(output_params))
# output_params =  output_params %>% left_join(tdata, by="params")  %>% mutate(params.name = params)
# 

  
  tdata = PARAMS1000  %>% filter(minimization_successful==1) %>% select(-TVF1, -TVKA)
  
   TVCL = as_numeric(tdata$TVCL)  # ",] %>% as_numeric() #0.301
 EMAX=as_numeric(tdata$EMAX)  #%>% as_numeric()#-0.432
 T50= as_numeric(tdata$T50) #%>% as_numeric()#31.68
 HILL= as_numeric(tdata$HILL) #%>% as_numeric() #2.489
 TIME= 24*7 
 tdata$CLss = TVCL*exp(EMAX*TIME**HILL/(T50**HILL+TIME**HILL)) 
 tdata$CL.reduction.pct =  (tdata$TVCL - tdata$CLss)/tdata$TVCL*100
   
 # half life
 tdata$KE  = as_numeric(tdata$CLss)/as_numeric(tdata$TVV2)    # 1/day, 	Elimination rate constant     0.365
  tdata$K32 = as_numeric(tdata$TVQ)/as_numeric(tdata$TVV3)# THETA['TVQ']/THETA['TVV3'];  
  tdata$K23 = as_numeric(tdata$TVQ)/as_numeric(tdata$TVV2) #THETA['TVQ']/THETA['TVV2'];
  alpha.plus.beta  <- tdata$KE + tdata$K23 + tdata$K32
  alpha.multi.beta <- tdata$KE * tdata$K32
  alpha <- (alpha.plus.beta + sqrt(alpha.plus.beta^2-4*alpha.multi.beta))/2
  beta  <- (alpha.plus.beta - sqrt(alpha.plus.beta^2-4*alpha.multi.beta))/2
  tdata$alpha.half.life <- 0.693/alpha
  tdata$beta.half.life <- 0.693/beta
  
  
  col.lst = tdata %>% select(starts_with("TV"), 
                             starts_with("RUV", ignore.case=FALSE), 
                             EMAX,T50,HILL, 
                             matches("_ON_"), 
                             starts_with("IIV", ignore.case=FALSE), 
                             OMEGA.2.1., 
                             CLss, CL.reduction.pct, alpha.half.life, beta.half.life) %>% 
    select(-starts_with("se", ignore.case=FALSE))  %>% colnames()
  
  
  param.name = col.lst[1] 
  OUT = lapply(col.lst, function(param.name) {
      calc_stats(tdata, id="model", group_by=NULL, value=param.name) %>% 
        select(N, Mean_CV, Median, GEOmean, PCT2P5, PCT97P5) %>% 
        mutate(CI95=paste0("[", u.signif(PCT2P5, digits=3), "-", u.signif(PCT97P5, digits=3), "]")) %>%
        mutate("param.name"=param.name) %>%
        select(-PCT2P5, -PCT97P5)
  })  %>% bind_rows()  %>% as.data.frame()
  

  # from LN900 model
  runno.lst = final.model.runno
 PARAMS = read_PARAMS(MODEL.HOME, subdir="/ctl/HPC/", runno.lst) 
 tdata = PARAMS[[1]] %>% select(-TVF1, -TVKA) %>% as.data.frame()
 colnames(tdata) = gsub("OMEGA(2,1)", "OMEGA.2.1.", colnames(tdata) , fix=TRUE)
 
 TVCL = as_numeric(tdata$TVCL)  # ",] %>% as_numeric() #0.301
 EMAX=as_numeric(tdata$EMAX)  #%>% as_numeric()#-0.432
 T50= as_numeric(tdata$T50) #%>% as_numeric()#31.68
 HILL= as_numeric(tdata$HILL) #%>% as_numeric() #2.489
 TIME= 24*7 
 tdata$CLss = TVCL*exp(EMAX*TIME**HILL/(T50**HILL+TIME**HILL)) 
 tdata$CL.reduction.pct = u.signif((tdata$CLss - tdata$TVCL)/tdata$TVCL*100, digits=3)
 
 # half life
 tdata$KE  = as_numeric(tdata$CLss)/as_numeric(tdata$TVV2)    # 1/day, 	Elimination rate constant     0.365
  tdata$K32 = as_numeric(tdata$TVQ)/as_numeric(tdata$TVV3)# THETA['TVQ']/THETA['TVV3'];  
  tdata$K23 = as_numeric(tdata$TVQ)/as_numeric(tdata$TVV2) #THETA['TVQ']/THETA['TVV2'];
  alpha.plus.beta  <- tdata$KE + tdata$K23 + tdata$K32
  alpha.multi.beta <- tdata$KE * tdata$K32
  alpha <- (alpha.plus.beta + sqrt(alpha.plus.beta^2-4*alpha.multi.beta))/2
  beta  <- (alpha.plus.beta - sqrt(alpha.plus.beta^2-4*alpha.multi.beta))/2
  tdata$alpha.half.life <- 0.693/alpha
  tdata$beta.half.life <- 0.693/beta
  
  tdata = tdata %>% select(one_of(col.lst))   %>% t() %>% as.data.frame() %>% mutate("param.name"=rownames(.))
   
 
t1 = tdata %>% filter(param.name %in% col.lst) %>% mutate(LN900=u.signif(as_numeric(V1), digits=3))
OUT = OUT %>% as.data.frame()  %>% left_join(t1, by="param.name")
tabl = OUT %>% select(param.name,  LN900,  Mean_CV,  Median, GEOmean,   CI95)
final.param.tabl = tabl
  
tabl  = tabl %>% as.matrix() %>% as.data.frame() %>% 
  mutate(Median_CI95 = paste(u.signif(Median,digits=3), CI95, sep=""), 
         GEOmean = u.signif(GEOmean, digits=3))

tabl = tabl %>% filter(!param.name %in% c("CLss", "CL.reduction.pct", "alpha.half.life", "beta.half.life"))

tabl = tabl %>% select(param.name,	LN900,	Mean_CV,	Median_CI95,	GEOmean	)

colnames(tabl) <- gsub("param.name", "Parameter", colnames(tabl), fix=TRUE)
colnames(tabl) <- gsub("LN900", "Estimate from \n(analysis set)", colnames(tabl), fix=TRUE)

colnames(tabl) <- gsub("Mean_CV", "Mean(CV)", colnames(tabl), fix=TRUE)
colnames(tabl) <- gsub("Median_CI95", "Median[CI95]", colnames(tabl), fix=TRUE)
colnames(tabl) <- gsub("GEOmean", "GEOmean Estimate from \n1,000 Bootstrap", colnames(tabl), fix=TRUE)
 
# Mean (CV)	Median	GEOmean	CI95
# tabl$param.name = gsub("CLss", "CLss*", tabl$param.name, fix=TRUE)
# tabl$param.name = gsub("CL.reduction.pct", "CL.reduction.pct*", tabl$param.name, fix=TRUE)
# tabl$param.name = gsub("alpha.half.life", "alpha.half.life*", tabl$param.name, fix=TRUE)
# tabl$param.name = gsub("beta.half.life", "beta.half.life*", tabl$param.name, fix=TRUE)

tabl
  
  
   

TABLE_ALL[["final_model_bootstrap"]] = tabl

caption = paste0("Summary of Parameter Values After Modelling with Original NONMEM Input Data File or Bootstrap Datasets for the Final Model (", final.model.runno, ")")
knitr::kable(tabl, booktabs = TRUE, caption = caption)
 
 


```

  

### \@ref(result-final-model-VPC) Model Predictability {#result-final-model-VPC}

Visual predictive checks (VPCs) were constructed to evaluate the model predictability.  Overall, model described the observed data well, and that the assumptions about random variability were reasonably satisfied. 

Figure \@ref(fig:vpc-final-model-normalized) shows a representative VPC of dose-normalized concentration versus actual time following the previous dose at 1, 3, 10 mg/kg, and 200 mg every two weeks (Q2W). Figure \@ref(fig:vpc-final-model-by-dose) represent observed cemiplimab concentrations stratified for the different dosage regimens.    

The plots showed that observed concentrationâtime course of cemiplimabat the 5th, 50th, and 95th percentiles fell within their corresponding 90% prediction intervals, indicating that the model adequately predicted the central tendency (median) and extremes (5th and 95th percentiles) of the concentrationâtime profile of cemiplimab in the dose range studied.  Some minor trends of increasing concentrations beyond 20 weeks were visible in the VPC plot at the last portion of the concentration time curves, which was captured by model component of the time-varying CL.

In summary, the cemiplimab population PK model evaluation results, which included the results of simulation and nonparametric bootstrap, revealed that the final model provided a reliable description of the data with good precision of structural model and variance parameter estimates. 
 
  
  
  

 
```{r simPK-for-VPC, eval=TRUE  }
 


################################################################################
# load mrgsolve models 
################################################################################
# read model
library(dplyr)
source("./cpp/mod.R2810.LN014.cpp")
mod <- mread("R2810", tempdir(),mymodel)     # ?mread , ?mcode
 
#mod_MM = mod %>% param(THETA_MM)
#param(mod_MM)  
   

seed =1234
set.seed(seed);    

#----------------------------------------  
# adpx
#----------------------------------------

runno = final.model.runno     # "LN014" # "LN001"
OUTPUT = read_OUTPUT(MODEL.HOME="H:\\FYANG\\R2810_PD1\\MODEL\\", subdir="/ctl/HPC/", runno, adpx00)

adpx = OUTPUT[[runno]]   %>% filter(C==".")
  
adpx = adpx %>% filter(USUBJID!="R2810-ONC-1423-840004-006")

adpx = adpx %>% mutate(ID=as_numeric(ID), 
                       CMT=as_numeric(CMT),
                       MDV=as_numeric(MDV),
                       EVID=as_numeric(EVID),
                       WGTBL=as_numeric(WGTBL),
                         TIME=as_numeric(TIME), 
                         NTIM=as_numeric(NTIM),
                         AMT=as_numeric(AMT),
                         RATE=as_numeric(RATE))  %>% 
  filter(TIME>=0)
#adpx =adpx %>% rename(TVKA=KA, TVCL=CL, TVQ=Q, TVV2=V2, TVV3=V3) 
adpx$POP = "SIM"

adpx = adpx %>% select(POP, STUDYID, USUBJID, ARMA, ID, TIME, NTIM, AMT, CMT, MDV, RATE,EVID, DVOR, WGTBL, ALBBL, IGGBL)
     
#adpx = adpx %>% arrange(ID, TIME, -EVID)
#----------------------------------------
# run simulation
#---------------------------------------- 

# setup simulation timept 
treat_end = 24*14;  sim_end = 28*14
 
#treat_end = 24*7;  sim_end = 32*7
tgrid = sim_timept(start=0, end=sim_end, delta=1, dtime=seq(0, treat_end, by=7))

#colnames(adpx) = tolower(colnames(adpx))
out = mod %>% #omat(CLQ_VSS=dmat(0,0),   IIV_EMAX=dmat(0), IIV_T50=dmat(0)) %>%  
data_set(adpx) %>%  carry.out(NTIM) %>% mrgsim(end=sim_end, delta=1, add=tgrid) %>% as.data.frame() #%>% capitalize_names()

out = out %>% left_join(adpx %>% as.data.frame() %>% distinct(USUBJID, .keep_all=TRUE) %>% select(ID, POP, STUDYID, USUBJID, ARMA), by="ID") 
colnames(out) = toupper(colnames(out))
SIMDATA = out


  
 
```





```{r vpc-final-model-normalized-day56, fig.cap='Observed Dose-normalized cemiplimab Concentrations with Median and Predicted 95% Confidence Intervals from the Simulation Based on the Final Model', fig.align='center', out.width='80%', fig.asp=.75}
 
library(ggplot2)
   
 tdata = SIMDATA %>% filter(ARMA!="3 mg/kg Q3W")
 tdata = tdata %>% mutate(IPRED=ifelse(ARMA=="200 mg Q2W", IPRED/(200/WGTBL)*3, 
                                       ifelse(ARMA=="1 mg/kg Q2W", IPRED/1*3, 
                                              ifelse(ARMA=="3 mg/kg Q2W", IPRED/3*3, 
                                                     ifelse(ARMA=="10 mg/kg Q2W", IPRED/10*3, IPRED)))))
  
  
tdata = tdata %>% calc_stats(id="ID", group_by=c( "NTIM"), value="IPRED")
tdata = tdata %>% filter(!is.na(NTIM), !is.na(Median)) %>% mutate(NTIM=as_numeric(NTIM)) %>% filter(NTIM<=56, NTIM>0)


adpx = adpx %>% filter(USUBJID!="R2810-ONC-1423-840004-006")
adpx = adpx %>% mutate(TIME=as_numeric(TIME), 
                       NTIM=as_numeric(NTIM),
                       DVOR=as_numeric(DVOR)) %>% filter(NTIM<=56, EVID==0)
 
x = tick_label(x=as_numeric(adpx$TIME), xmin=0, xmax=200, major.tick=7, minor.tick=7, log=FALSE)
 y = tick_label(x=as_numeric(adpx$DVOR), xmin=1E-2, xmax=1E+3,  log=TRUE) 

 
 
fig = ggplot(tdata, aes(x=NTIM, y=Median)) + geom_line() +
  #geom_point(aes(x=NTIM, y=PCT2P5), col="blue") + 
  #geom_point(aes(x=NTIM, y=PCT97P5), col="blue") + 
  geom_ribbon(aes(ymin=PCT2P5,ymax=PCT97P5), fill="gray50", alpha="0.5")   + 
scale_fill_manual(values=c(clear,blue)) + 
  
   xlab("Time (day)") + 
   ylab("Dose-normalized Concentration (mg/L)") + 
  
   base_theme(font.size=14) + 
     scale_x_continuous(breaks=x$breaks, label=x$labels) + 
     scale_y_log10(breaks=y$breaks, label=y$labels) + 
  
     coord_cartesian(xlim = range(adpx$TIME, na.rm=TRUE)) + 
     coord_cartesian(ylim = range(adpx$DVOR, na.rm=TRUE)) + 
     
   theme(#legend.title=element_text("EXSEQ"), 
         legend.position=c(0.90, 0.85), 
         panel.grid.minor= element_line(colour = "gray95",size=0.5),
         panel.grid.major= element_line(colour = "gray95",size=0.5),
         panel.spacing = unit(0.2, "lines"), 
         panel.border=element_rect(colour="black", fill=NA), 
         strip.background = element_blank()   # element_rect(colour=NA, fill=NA),
   ) 
 


  tdata = adpx %>% mutate(DVOR=ifelse(ARMA=="200 mg Q2W", DVOR/(200/WGTBL)*3, 
                                       ifelse(ARMA=="1 mg/kg Q2W", DVOR/1*3, 
                                              ifelse(ARMA=="3 mg/kg Q2W", DVOR/3*3, 
                                                     ifelse(ARMA=="10 mg/kg Q2W", DVOR/10*3, DVOR)))))
  
fig =  fig + geom_point(data=tdata, aes(x=TIME, y=DVOR))  


FIGURE_ALL[["final_model_dose_normalized_VPC_day56"]] = fig
  
fig


```

Note: Model validation representative visual predictive check from final population pharmacokinetic model: dose-normalized cemiplimabcon centration versus actual time after dose in the first treatment cycle (56 days). Representative visual predictive check of concentration (log scale) versus actual time. Dots are observed data and the solid lines represent the mean of the simulated data, and the shaded areas represent the simulation-based 95% confidence intervals for the 2.5th and 97.5th percentiles of the predicted data. Subjects with 3 mg/kg Q3W were not included in this plot.
 
  
  


```{r vpc-final-model-normalized-day168, fig.cap='Observed Dose-normalized cemiplimab Concentrations with Median and Predicted 95% Confidence Intervals from the Simulation Based on the Final Model', fig.align='center', out.width='80%', fig.asp=.75}
 
library(ggplot2)
   
 tdata = SIMDATA %>% filter(ARMA!="3 mg/kg Q3W")
 tdata = tdata %>% mutate(IPRED=ifelse(ARMA=="200 mg Q2W", IPRED/(200/WGTBL)*3, 
                                       ifelse(ARMA=="1 mg/kg Q2W", IPRED/1*3, 
                                              ifelse(ARMA=="3 mg/kg Q2W", IPRED/3*3, 
                                                     ifelse(ARMA=="10 mg/kg Q2W", IPRED/10*3, IPRED)))))
  
  
tdata = tdata %>% calc_stats(id="ID", group_by=c( "NTIM"), value="IPRED")
tdata = tdata %>% filter(!is.na(NTIM), !is.na(Median)) %>% mutate(NTIM=as_numeric(NTIM)) %>% filter(NTIM<=168, NTIM>0)

adpx = adpx0 %>% filter(C==".", EVID==0)
adpx = adpx %>% filter(USUBJID!="R2810-ONC-1423-840004-006")
adpx = adpx %>% mutate(TIME=as_numeric(TIME), 
                       NTIM=as_numeric(NTIM),
                       DVOR=as_numeric(DVOR)) %>% filter(NTIM<=168, EVID==0)
 
x = tick_label(x=as_numeric(adpx$TIME), xmin=0, xmax=200, major.tick=56, minor.tick=28, log=FALSE)
 y = tick_label(x=as_numeric(adpx$DVOR), xmin=1E-2, xmax=1E+3,  log=TRUE) 

 
 
fig = ggplot(tdata, aes(x=NTIM, y=Median)) + geom_line() +
  #geom_point(aes(x=NTIM, y=PCT2P5), col="blue") + 
  #geom_point(aes(x=NTIM, y=PCT97P5), col="blue") + 
  geom_ribbon(aes(ymin=PCT2P5,ymax=PCT97P5), fill="gray50", alpha="0.5")   + 
scale_fill_manual(values=c(clear,blue)) + 
  
   xlab("Time (day)") + 
   ylab("Dose-normalized Concentration (mg/L)") + 
  
   base_theme(font.size=14) + 
     scale_x_continuous(breaks=x$breaks, label=x$labels) + 
     scale_y_log10(breaks=y$breaks, label=y$labels) + 
  
     coord_cartesian(xlim = range(adpx$TIME, na.rm=TRUE)) + 
     coord_cartesian(ylim = range(adpx$DVOR, na.rm=TRUE)) + 
     
   theme(#legend.title=element_text("EXSEQ"), 
         legend.position=c(0.90, 0.85), 
         panel.grid.minor= element_line(colour = "gray95",size=0.5),
         panel.grid.major= element_line(colour = "gray95",size=0.5),
         panel.spacing = unit(0.2, "lines"), 
         panel.border=element_rect(colour="black", fill=NA), 
         strip.background = element_blank()   # element_rect(colour=NA, fill=NA),
   ) 
 


adpx = adpx %>% filter(USUBJID!="R2810-ONC-1423-840004-006")
  tdata = adpx %>% mutate(DVOR=ifelse(ARMA=="200 mg Q2W", DVOR/(200/WGTBL)*3, 
                                       ifelse(ARMA=="1 mg/kg Q2W", DVOR/1*3, 
                                              ifelse(ARMA=="3 mg/kg Q2W", DVOR/3*3, 
                                                     ifelse(ARMA=="10 mg/kg Q2W", DVOR/10*3, DVOR)))))
  
fig =  fig + geom_point(data=tdata, aes(x=TIME, y=DVOR))  


FIGURE_ALL[["final_model_dose_normalized_VPC_day168"]] = fig
  
fig


```




```{r vpc-final-model-by-dose, fig.cap='Observed cemiplimab concentrations stratified for the different dosage regimens with Median and Predicted 95% Confidence Intervals from the Simulation Based on the Final Model', fig.align='center', out.width='80%', fig.asp=.75}
 
tdata = SIMDATA %>% calc_stats(id="ID", group_by=c("ARMA", "NTIM"), value="IPRED")
tdata = tdata %>% filter(!is.na(NTIM), !is.na(Median)) %>% filter(NTIM<=56, NTIM>0)

adpx = adpx0 %>% filter(C==".", EVID==0)
adpx = adpx %>% filter(USUBJID!="R2810-ONC-1423-840004-006")
adpx = adpx %>% mutate(TIME=as_numeric(TIME), 
                       NTIM=as_numeric(NTIM), 
                       DVOR=as_numeric(DVOR)) %>% filter(NTIM<=56)
 x = tick_label(x=as_numeric(adpx$TIME), xmin=0, xmax=200, major.tick=28, minor.tick=7, log=FALSE)
 y = tick_label(x=as_numeric(adpx$DVOR), xmin=1E-2, xmax=1E+3,  log=TRUE) 

 
fig = ggplot(tdata, aes(x=NTIM, y=Median)) + geom_line() +
  geom_ribbon(aes(ymin=PCT2P5,ymax=PCT97P5), fill="gray50", alpha="0.5")   + 
  scale_fill_manual(values=c(clear,blue)) + 
  
   xlab("Time (day)") + 
   ylab("Concentration (mg/L)") + 
  
   base_theme(font.size=14) + 
     scale_x_continuous(breaks=x$breaks, label=x$labels) + 
     scale_y_log10(breaks=y$breaks, label=y$labels) + 
  
     coord_cartesian(xlim = range(adpx$TIME, na.rm=TRUE)) + 
     coord_cartesian(ylim = range(adpx$DVOR, na.rm=TRUE)) + 
     
   theme(#legend.title=element_text("EXSEQ"), 
         legend.position=c(0.90, 0.85), 
         panel.grid.minor= element_line(colour = "gray95",size=0.5),
         panel.grid.major= element_line(colour = "gray95",size=0.5),
         panel.spacing = unit(0.2, "lines"), 
         panel.border=element_rect(colour="black", fill=NA), 
         strip.background = element_blank()   # element_rect(colour=NA, fill=NA),
   ) 
 
fig = fig + geom_point(data=adpx, aes(x=TIME, y=DVOR)) +
                         facet_wrap(~ARMA)  

FIGURE_ALL[["final_model_VPC"]] = fig


 fig
 
   
```

Black circles represent observations; solid black lines represent mean of simulated data and the gray area represents 95% CI of the median. 

 

