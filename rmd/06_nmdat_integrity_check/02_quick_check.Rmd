 
 

## Quick check  
A NONMEM formatted data file is created by using the clinical and bioanalytical databases.   In general, the following rules will be applied.  In particular, a dataset not passing _quick check_ will not be processed further.  To ensure the integrity and traceability of the data, no samples should be deleted, use 'C' to flag samples if needed and specify the reasons in 'CFLAG'.
 
```{r}
   nmdat.mandatory.col.lst = c("ROWID","ID","TIME","DV","CMT","MDV","AMT","RATE","EVID")
    PK.TEST.NAME = "REGN3918"    # unique(TEST)[1])PK.TEST.NAME
    
    
   nmdat_mandatory_check <- function(nmdat, values4nmdat)  {
      validate(need(nmdat, message=FALSE)) 
     
      values4nmdat = check.colnames.in.stdlist(nmdat, values4nmdat)      
         
   return(values4nmdat)
   }
   
   
   
   nmdat_quick_check <- function(nmdat, values4nmdat)  {
      validate(need(values4nmdat$mandatory_check, message=FALSE)) 
     
      values4nmdat = check.col.in.numint(nmdat, values4nmdat)     
      values4nmdat = check.colnames3(nmdat, values4nmdat)      
      values4nmdat = check.label.colnames.lt40(nmdat, values4nmdat)                       
      values4nmdat = check.obs.order.by.time(nmdat, values4nmdat)                       
      values4nmdat = check.missing.ID(nmdat, values4nmdat)                         
      values4nmdat = check.missing.TIME(nmdat, values4nmdat)                         
      values4nmdat = check.missing.MDV(nmdat, values4nmdat)                        
      values4nmdat = check.missing.CMT(nmdat, values4nmdat)                         
      values4nmdat = check.inconsistent.DV.MDV(nmdat, values4nmdat)     
         
   return(values4nmdat)
   }
```
 
*** 

<!-- A NONMEM dataset must contain mandatory variables indicated in below table.-->
```{r }
 check.colnames.in.stdlist <- function(nmdat, values4nmdat)  {
   validate(need(nmdat, message=FALSE))
   print("inside mandatory check...")
   #nmdat.mandatory.col.lst = values4nmdat$nmdat.mandatory.col.lst
   
   YN = nmdat.mandatory.col.lst %in% colnames(nmdat)  
   status <- all(YN)
   info = paste0(setdiff(nmdat.mandatory.col.lst, colnames(nmdat) ), collapse=", ")
   info = colFmt(paste0("Missing key variable in the dataset: ", info, "."),'red')
   
   values4nmdat$colnames.in.stdlist$status = status
   values4nmdat$colnames.in.stdlist$info = info
   if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
    
   values4nmdat$mandatory_check = values4nmdat$mandatory_check & status 
  
   # pass_quick_check
   values4nmdat$pass_quick_check = isolate(values4nmdat$pass_quick_check) & status 
   
   return(values4nmdat)
 }

yes_or_no <- renderUI(renderText({
  validate(need(values4nmdat$colnames.in.stdlist$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$colnames.in.stdlist$info, message=FALSE))
  
  ifelse(values4nmdat$colnames.in.stdlist$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info <- renderUI(renderText({
  validate(need(values4nmdat$colnames.in.stdlist$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$colnames.in.stdlist$info, message=FALSE))
  
  if(!values4nmdat$colnames.in.stdlist$status) {colFmt(values4nmdat$colnames.in.stdlist$info,'red')} 
  })() %>% HTML())
  
```

* `r (yes_or_no) `  A NONMEM dataset must contain mandatory variables incuding _ROWID_, _ID_, _TIME_, _DV_, _CMT_, _MDV_, _AMT_, _RATE_, _EVID_.  See [Confluence](https://sandboxconfluence.regeneron.com/display/PMx/Data+format). 
    + `r (info) ` 
 
 
*** 
     
<!-- 
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
All mandatory primary variables except C and CFLAG must be numeric value.
--> 
```{r }
 check.col.in.numint <- function(nmdat, values4nmdat)  {
 
   validate(need(nmdat, message=FALSE), 
            need(values4nmdat$mandatory_check, message="Must pass mandatory check...")
   )
   print("inside col.in.numint")
   
   col.lst <- setdiff(intersect(nmdat.mandatory.col.lst, colnames(nmdat)), c("C", "CFLAG"))
   YN = sapply(nmdat[, col.lst], typeof) %in% c("double", "integer")  # class
   status <- all(YN)
   info = paste0(col.lst[which(!YN)], collapse=", ")
   info = colFmt(paste0("Colnames, ", info, ", is/are not numeric or integer in the dataset."),'red')
   
   values4nmdat$col.in.numint$status = status
   values4nmdat$col.in.numint$info = info
   if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
   
   # pass_quick_check
   values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
   return(values4nmdat) 
}
 
yes_or_no <- renderUI(renderText({
  validate(need(values4nmdat$mandatory_check, message=FALSE),
           need(values4nmdat$col.in.numint$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$col.in.numint$info, message=FALSE))
   
  ifelse(values4nmdat$col.in.numint$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info <- renderUI(renderText({
  validate(need(values4nmdat$mandatory_check, message=FALSE),
           need(values4nmdat$col.in.numint$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$col.in.numint$info, message=FALSE))
     
  if(!values4nmdat$col.in.numint$status) {colFmt(values4nmdat$col.in.numint$info,'red')} 
  })() %>% HTML())
  
```

* `r (yes_or_no) ` All mandatory primary variables except C and CFLAG must be integer or numeric, as shown in [Confluence](https://sandboxconfluence.regeneron.com/display/PMx/Data+format). 
    + `r (info) ` 
 
 
***
  
<!-- 3. The variable names can not exceed 8 characters,  should be in upper case, and can't start with numbers.  --> 
```{r, echo = FALSE}
 check.colnames3 <- function(nmdat, values4nmdat)  {
   
   validate(need(nmdat, message=FALSE), 
            need(values4nmdat$mandatory_check, message="Must pass mandatory check...")
   )
   print("inside nchar(colname) <8 ...")
    
   status1 = all(nchar(colnames(nmdat))<=8)
   info = paste0(colnames(nmdat)[which((nchar(colnames(nmdat))>8))], collapse=", ")
   info = colFmt(paste0("Length of colnames, ", info, ", greater than 8 characters."),'red')
   values4nmdat$colnames.length.le8$status = status1
   values4nmdat$colnames.length.le8$info = info
   if(!status1) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
   
   YN <- colnames(nmdat)==toupper(colnames(nmdat))
   status2 = all(YN)
   info = paste0(colnames(nmdat)[which(!YN)], collapse=", ")
   info = colFmt(paste0("Variable name not in upper case: ", info, "."),'red')
   values4nmdat$colnames.uppercase$status = status2
   values4nmdat$colnames.uppercase$info = info
   if(!status2) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
   
   YN <- is.na(substr(colnames(nmdat), 1,1) %>% as_numeric())
   status3 = all(YN)
   info = paste0(colnames(nmdat)[which(!YN)], collapse=", ")
   info = colFmt(paste0("Variable name can't start with numbers:", info, "."),'red')
   values4nmdat$colnames.not.start.num$status = status3
   values4nmdat$colnames.not.start.num$info = info
   if(!status3) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
   
   # pass_quick_check
   values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status1 & status2 & status3 
     
   return(values4nmdat) 
}


yes_or_no <- renderUI(renderText({
    validate(need(values4nmdat$mandatory_check, message=FALSE),
           need(values4nmdat$colnames.length.le8$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$colnames.length.le8$info, message=FALSE), 
           
           need(values4nmdat$colnames.uppercase$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$colnames.uppercase$info, message=FALSE), 
           
           need(values4nmdat$colnames.not.start.num$status %in% c(TRUE, FALSE), message=FALSE), 
           need(values4nmdat$colnames.not.start.num$info, message=FALSE) 
    )
           
   
  ifelse(
   values4nmdat$colnames.length.le8$status  & 
   values4nmdat$colnames.uppercase$status   & 
   values4nmdat$colnames.not.start.num$status,
   
   colFmt(asis_output("\U2714"),'green'), 
   colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info1 <- renderUI(renderText({
  validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$colnames.length.le8$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$colnames.length.le8$info, message=FALSE)
  )
  if(!values4nmdat$colnames.length.le8$status) {colFmt(values4nmdat$colnames.length.le8$info,'red')} 
  })() %>% HTML())

info2 <- renderUI(renderText({
    validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$colnames.uppercase$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$colnames.uppercase$info, message=FALSE)
  )
  
  if(!values4nmdat$colnames.uppercase$status) {colFmt(values4nmdat$colnames.uppercase$info,'red')}
  })() %>% HTML())

info3 <- renderUI(renderText({
      validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$colnames.not.start.num$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$colnames.not.start.num$info, message=FALSE)
  )
  
  if(!values4nmdat$colnames.not.start.num$status) {colFmt(values4nmdat$colnames.not.start.num$info,'red')}
  })() %>% HTML())
 
```

* `r (yes_or_no) ` The variable names can not exceed 8 characters, should be in upper case, and can't start with numbers. 
    + `r (info1) ` 
    + `r (info2) `
    + `r (info3) `

   
  
*** 

<!-- The label for variables can not be exceeded 40 characters--> 
```{r }
 
check.label.colnames.lt40 <- function(nmdat, values4nmdat)  {
      
  validate(need(nmdat, message=FALSE), 
              need(values4nmdat$mandatory_check, message="Must pass mandatory check...")
  )
   print("inside label.colnames.lt40 ...")
 
   YN = nchar(label(nmdat))<=40
   status <- all(YN)
   info = paste0(label(nmdat)[which(!YN)], collapse=", ")
   info = colFmt(paste0("Label of variables, ", info, ", greater than 40 characters."),'orange')
   
   values4nmdat$label.colnames.lt40$status <- status
   values4nmdat$label.colnames.lt40$info = info
   if(!status) {values4nmdat$yellow_alert = rbind(isolate(values4nmdat$yellow_alert), info)}
   
   # pass_quick_check
   values4nmdat$pass_quick_check =  values4nmdat$pass_quick_check &  status
   return(values4nmdat) 
 }
 
yes_or_no <- renderUI(renderText({
     validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$label.colnames.lt40$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$label.colnames.lt40$info, message=FALSE)
  )
  
  ifelse(values4nmdat$label.colnames.lt40$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info <- renderUI(renderText({
       validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$label.colnames.lt40$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$label.colnames.lt40$info, message=FALSE)
  )
  
  if(!values4nmdat$label.colnames.lt40$status) {colFmt(values4nmdat$label.colnames.lt40$info,'orange')} 
  })() %>% HTML())
  
```

* `r (yes_or_no) ` The label of variables can not be exceeded 40 characters.
    + `r (info) ` 
 
 
***

  
<!-- All observations (PK, biomarker and PD) or events within a subject should be ordered by TIME.-->

```{r }
check.obs.order.by.time <- function(nmdat, values4nmdat)  {
     validate(need(nmdat, message=FALSE), 
              need(values4nmdat$mandatory_check, message="Must pass mandatory check..."), 
              need(all(c("ID", "TIME") %in% colnames(nmdat)), message="Need both ID and TIME variable"))
     print("inside obs.order.by.time ...")
   
     t1 = nmdat %>% group_by(ID) %>% 
       dplyr::mutate(TIME2 = sort(as_numeric(TIME))) %>% 
       dplyr::summarise(YN=all(TIME==TIME2)) %>% arrange(ID) 
     status <- all(t1$YN)   
     info = paste0(t1[which(!t1$YN), "ID"], collapse=", ") 
     info = colFmt(paste0("The observations or dose events within suject ID(s),", info, ", are not ordered by TIME."), "red")
     
     values4nmdat$obs.order.by.time$status = status
     values4nmdat$obs.order.by.time$info = info
     if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
     
     # pass_quick_check
     values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
     
   return(values4nmdat)
 }
 
yes_or_no <- renderUI(renderText({
       validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$obs.order.by.time$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$obs.order.by.time$info, message=FALSE)
  )
  
  ifelse(values4nmdat$obs.order.by.time$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info <- renderUI(renderText({
  validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$obs.order.by.time$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$obs.order.by.time$info, message=FALSE)
  )
  
  if(!values4nmdat$obs.order.by.time$status) {colFmt(values4nmdat$obs.order.by.time$info,'red')} 
  })() %>% HTML())
   
```

* `r (yes_or_no) ` All observations (PK, biomarker and PD) or dose events within a subject have to be ordered by TIME. 
    + `r (info) ` 
 
 
*** 
  
<!-- No missing ID values, all ID must be integer -->

```{r }
check.missing.ID <- function(nmdat, values4nmdat)  {
     validate(need(nmdat, message=FALSE), 
              need(values4nmdat$mandatory_check, message="Must pass mandatory check..."), 
              need("ID" %in% colnames(nmdat), message="Need ID variable!"))
     print("in missing.ID... ")
         
     status <- all(!is.na(as.integer(nmdat$ID)))  
     info = paste0(nmdat[which(is.na(as.integer(nmdat$ID))), "ROWID"], collapse=", ") 
     info = colFmt(paste0("The ID in ROWID(s), ", info, ", is/are missing."), "red")
     
     values4nmdat$missing.ID$status = status
     values4nmdat$missing.ID$info = info
     if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
     
     # pass_quick_check
     values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
    
   return(values4nmdat)
}
 
yes_or_no <- renderUI(renderText({
       validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.ID$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.ID$info, message=FALSE)
  )
  
  ifelse(values4nmdat$missing.ID$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info <- renderUI(renderText({
        validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.ID$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.ID$info, message=FALSE)
  )
  
  if(!values4nmdat$missing.ID$status) {colFmt(values4nmdat$missing.ID$info,'red')} 
  })() %>% HTML())
   
```

* `r (yes_or_no) ` No missing ID values, all ID must be integer. 
    + `r (info) ` 
 
 
*** 



<!-- No missing TIME values, all TIME must be integer -->
  
```{r }
check.missing.TIME <- function(nmdat, values4nmdat)  {

   validate(need(nmdat, message=FALSE), 
            need(values4nmdat$mandatory_check, message="Must pass mandatory check..."),
            need(all(c("ROWID", "TIME") %in% colnames(nmdat)), message=FALSE)
   )
  print("in missing.TIME ")
  
  status <- all(!is.na(as.integer(nmdat$TIME)))  
  info = paste0(nmdat[which(is.na(as.integer(nmdat$TIME))), "ROWID"], collapse=", ") 
  info = colFmt(paste0("The TIME in ROWID(s), ", info, ", is/are missing."), "red")
  
  values4nmdat$missing.TIME$status = status
  values4nmdat$missing.TIME$info = info
  if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
  
  # pass_quick_check
  values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
  
  return(values4nmdat) 
}

yes_or_no <- renderUI(renderText({
        validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.TIME$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.TIME$info, message=FALSE)
  )
  
  ifelse(values4nmdat$missing.TIME$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
})() %>% HTML())

info <- renderUI(renderText({
       validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.TIME$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.TIME$info, message=FALSE)
  )
  
  if(!values4nmdat$missing.TIME$status) {colFmt(values4nmdat$missing.TIME$info,'red')} 
})() %>% HTML())

```

* `r (yes_or_no) ` No missing TIME values, all TIME must be integer. 
    + `r (info) ` 


*** 

<!-- No missing MDV values, all MDV must be integer -->

```{r }
check.missing.MDV <- function(nmdat, values4nmdat)  {

   validate(need(nmdat, message=FALSE), 
            need(values4nmdat$mandatory_check, message="Must pass mandatory check..."),
            need(all(c("ROWID", "MDV") %in% colnames(nmdat)), message=FALSE)
   )
   print("in missing.MDV ")
   
   status <- all(!is.na(as.integer(nmdat$MDV)))  
   info = paste0(nmdat[which(is.na(as.integer(nmdat$MDV))), "ROWID"], collapse=", ") 
   info = colFmt(paste0("The MDV in ROWID(s), ", info, ", is/are missing."), "red")
   
   values4nmdat$missing.MDV$status = status
   values4nmdat$missing.MDV$info = info
   if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
   
   # pass_quick_check
   values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
     
   return(values4nmdat) 
}
 
yes_or_no <- renderUI(renderText({
       validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.MDV$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.MDV$info, message=FALSE)
  )
  
  ifelse(values4nmdat$missing.MDV$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
  })() %>% HTML())

info <- renderUI(renderText({
        validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.MDV$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.MDV$info, message=FALSE)
  )
  
  if(!values4nmdat$missing.MDV$status) {colFmt(values4nmdat$missing.MDV$info,'red')} 
  })() %>% HTML())
   
```

* `r (yes_or_no) ` No missing MDV values, all MDV must be integer. 
    + `r (info) ` 
 
 
*** 


<!-- No missing CMT values, all CMT must be integer -->
  
```{r }
check.missing.CMT <- function(nmdat, values4nmdat)  {

  validate(need(nmdat, message=FALSE), 
            need(values4nmdat$mandatory_check, message="Must pass mandatory check..."),
            need(all(c("ROWID", "CMT") %in% colnames(nmdat)), message=FALSE)
  )
  print("in missing.CMT ")
  
  status <- all(!is.na(as.integer(nmdat$CMT)))  
  info = paste0(nmdat[which(is.na(as.integer(nmdat$CMT))), "ROWID"], collapse=", ") 
  info = colFmt(paste0("The CMT in ROWID(s), ", info, ", is/are missing."), "red")
  
  values4nmdat$missing.CMT$status = status
  values4nmdat$missing.CMT$info = info
  if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
  
  # pass_quick_check
  values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
  
   return(values4nmdat) 
}

yes_or_no <- renderUI(renderText({
        validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.CMT$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.CMT$info, message=FALSE)
  )
  
  ifelse(values4nmdat$missing.CMT$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
})() %>% HTML())

info <- renderUI(renderText({
        validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$missing.CMT$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$missing.CMT$info, message=FALSE)
  )
  
  if(!values4nmdat$missing.CMT$status) {colFmt(values4nmdat$missing.CMT$info,'red')} 
})() %>% HTML())

```

* `r (yes_or_no) ` No missing CMT values, all CMT must be integer. 
    + `r (info) ` 


*** 
 

<!--  when DV missing, should set MDV =1. -->
```{r }
check.inconsistent.DV.MDV <- function(nmdat, values4nmdat)  {

   validate(need(nmdat, message=FALSE), 
            need(values4nmdat$mandatory_check, message="Must pass mandatory check..."),
            need(all(c("ROWID", "DV", "MDV") %in% colnames(nmdat)), message=FALSE)
   )
 
  print("in inconsistent.DV.MDV ")
   
  tabl = nmdat %>% filter(is.na(as_numeric(DV)), as.integer(MDV)==0)  
  status <- nrow(tabl)==0
 
  info = paste0(tabl[, "ROWID"], collapse=", ") 
  info = colFmt(paste0("Inconsistent DV and MDV found in ROWID(s), ", info, "."), "red")
  
  values4nmdat$inconsistent.DV.MDV$status = status
  values4nmdat$inconsistent.DV.MDV$info = info
  if(!status) {values4nmdat$red_alert = rbind(isolate(values4nmdat$red_alert), info)}
  
  # pass_quick_check
  values4nmdat$pass_quick_check = values4nmdat$pass_quick_check & status 
  
  return(values4nmdat) 
}

yes_or_no <- renderUI(renderText({
        validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$inconsistent.DV.MDV$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$inconsistent.DV.MDV$info, message=FALSE)
  )
  
  ifelse(values4nmdat$inconsistent.DV.MDV$status, colFmt(asis_output("\U2714"),'green'),  colFmt(asis_output("\U2718"),'red'))
})() %>% HTML())

info <- renderUI(renderText({
         validate(need(values4nmdat$mandatory_check, message=FALSE),
       need(values4nmdat$inconsistent.DV.MDV$status %in% c(TRUE, FALSE), message=FALSE), 
       need(values4nmdat$inconsistent.DV.MDV$info, message=FALSE)
  )
  
  if(!values4nmdat$inconsistent.DV.MDV$status) {colFmt(values4nmdat$inconsistent.DV.MDV$info,'red')} 
})() %>% HTML())

```

* `r (yes_or_no) ` When DV missing, should set MDV=1.
    + `r (info) ` 


*** 


<!--   a sammple can be 'missing', can be 'na'(not available), can be BLQ.  -->
 
 
```{r}
# 
# <!-- 2. No placebo subjects have quantifiable PK measurements.-->
# ```{r,echo = FALSE}
# tabl = nmdat %>% filter(toupper(ARMA)=="PLACEBO", 
#                  TEST==PK.TEST.NAME) %>% group_by(ID, TEST) %>% dplyr::summarise(sumDVOR = sum(as_numeric(abs(DVOR)), na.rm=TRUE)) %>% 
#          filter(sumDVOR>0) %>% ungroup()
# 
# YN = length(tabl$sumDVOR)==0 || tabl$sumDVOR==0
# ```
# 2. `r ifelse(YN, colFmt(asis_output("\U2714"),'green'), colFmt(asis_output("\U2718"),'red'))` No placebo subjects have quantifiable PK measurements. 
#     
#     
# ```{r placebo.have.quantifiable.PK, anchor="table", tab.cap="The following placebo subjects have quantifiable PK measurements. ", tab.align='center'}
# if (!YN) {kable(nmdat %>% filter(ID %in% tabl$ID, as_numeric(DVOR)>0) %>% select(ID, TEST, NTIM, TIME, DVOR) %>% arrange(ID, TIME, TEST)) }
```





### Summary of quick check
If needed, here summarises all the red alerts if the loaded nonmem data did not pass the _quick check_. You have to fix them before performing further analysis. 

```{r}
# Outputting multiple lines of text with renderText() in R shiny
# https://stackoverflow.com/questions/23233497/outputting-multiple-lines-of-text-with-rendertext-in-r-shiny
renderUI(renderText({
  validate(need(!values4nmdat$pass_quick_check, message=FALSE),   # if not pass
           need( values4nmdat$red_alert, message=FALSE))
    
    info = values4nmdat$red_alert
    info = info[which(!is.null(info) & info!="")]
    n = length(info)
    paste0(paste0(1:n, ". ", info), sep = '<br/>')
  })() %>% HTML())

```
 

If needed, here summarises all the yellow alerts captured in checking nonmem data in _quick check_. You may perform further analysis without fixing them. 

```{r}
# Outputting multiple lines of text with renderText() in R shiny
# https://stackoverflow.com/questions/23233497/outputting-multiple-lines-of-text-with-rendertext-in-r-shiny
renderUI(renderText({
  validate(need(values4nmdat$yellow_alert, message=FALSE))   # if not pass
  
    info = values4nmdat$yellow_alert
    info = info[which(!is.null(info) & info!="")]
    n = length(info)
    paste0(paste0(1:n, ". ", info), sep = '<br/>')
  })() %>% HTML())

``` 
  
  
  








 

We can  embed plots, for example:

```{r first, eval=FALSE, anchor="figure", fig.cap="Rather small sample", fig.align='center'}
file.name = paste0(HOME, "/data/nmdat_PKPD_1024_2018.csv")
nmdat = read_csv(file.name, 
                 col_type=cols(.default=col_character()))   # read as character as defualt


nmdat <- nmdat %>% 
  mutate(ARMA = gsub("_", " ", ARMA, fix=TRUE), 
         ARMA = ordered(ARMA, levels=unique(as.character(ARMA))), # make ARMA as a ordered factor
         ARMAN = as.integer(ARMA), 
         TIME=as.numeric(TIME), 
         DV   = as.numeric(DV),
         DVOR = as.numeric(DVOR), 
         ID = as.integer(ID), 
         TIME = as.numeric(TIME), 
         AMT = as.numeric(AMT),  ################
         RATE = as.numeric(RATE), 
         EVID = as.integer(EVID), 
         CMT = as.integer(CMT), 
         MDV = as.integer(MDV), 
         NTIM = as.numeric(NTIM),
         LLOQ = as.numeric(LLOQ)
         
         
         #WGTBL = as.numeric(WGTBL),
         #CH50HBL = as.numeric(CH50HBL), 
         #C5BL = as.numeric(C5BL) 
)

  mydata = nmdat%>%filter(TEST%in%c("REGN3918", "CH50H"))  #, "CH50H"
    
  #fig = ggplot(mydata, aes(x=(TIME), y=(DVOR), group=ID, col=ARMA)) + 
  #  geom_point() + geom_line()  + facet_wrap(~TEST, ncol=1)
   
  callModule(module_ggplot_brush, "myggplot_pkpd", 
             fig=ggplot(mydata, aes(x=(TIME), y=(DVOR), group=ID, col=ARMA)) + 
                 geom_point() + geom_line()  + facet_wrap(~TEST, ncol=1), 
             mydata=mydata, xvar="TIME", yvar="DVOR")

  renderUI({ 
    module_ggplot_brush_UI(id="myggplot_pkpd", label = "myggplot_brush")
 
  })
 
```
 
 

 