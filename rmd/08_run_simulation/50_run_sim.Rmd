 

# Simulation <a name="run_sim"></a>

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this: 


## Run simulation <a name="run_sim"></a>

Simulated results were generated at this section, including 
1. single, population mean simulatin; 
2. population simulation
3. post-hoc simulation

```{r}
output$run_simulation <- renderUI({ 
   
  ALL = callModule(module_runsim, "run_simulation", 
                   ALL, cppModel_name = "mYtEsT_for_run_simulation")  
  module_runsim_UI(id="run_simulation", label = NULL)

})

fluidRow(column(12, uiOutput(("run_simulation"))))
```

 
 
## Summarise exposure <a name="run_sim"></a>
You can calculate the individual exposure, and summarise them based on the dose group. 
generate summary tables and visualizations. 

```{r}
#-----------------------------------------
# data_selector
#-----------------------------------------
output$data_selector_for_summarise_exposure <- renderUI({

  validate(need(ALL$DATA, message=FALSE))
  
  data.lst = c("", unique(names(ALL$DATA)))
  selectizeInput(("data_name_for_summarise_exposure"), 
                 label    = "select dataset:" , 
                 choices  = data.lst,  #unique(inputData()%>%pull(TEST)),    
                 multiple = FALSE, 
                 
                 selected = data.lst[1])  #unique(inputData()%>%pull(TEST))[1])   
})
#fluidRow(column(12, uiOutput(("data_selector_for_summarise_exposure"))))
  
```


```{r}
output$load_dataset_container <-renderUI({
   
  # callModule 
  #isolate({ 
    ALL = callModule(module_load_dataset, "load_dataset_for_summarise_exposure", 
                     ALL, dataset_name="mYtEsT_for_summarise_exposure")
  #})
  
  # UI  
  fluidRow(column(6, 
                   module_load_dataset_UI(id="load_dataset_for_summarise_exposure", label=NULL)
                 ), 
            column(6, 
                   HTML(colFmt("internal library: build-in dataset <br>
                                within session: secondary data derived from the original <br> 
                                external file: external file", color="gray")
                        )
                   )
            )  
  })
fluidRow(column(12, uiOutput(("load_dataset_container"))))
```
 
  
```{r} 

output$summarise_exposure<- renderUI({  
  validate(need(ALL$DATA[["mYtEsT_for_summarise_exposure"]], message=FALSE))
  
  
script= readLines(paste0(HOME, "/script/simdata_summary_exposure.R"))
script  = paste0(script, collapse="\n")

  ALL =  callModule(module_run_script, "summarise_exposure", ALL, 
                    dataset=ALL$DATA[["mYtEsT_for_summarise_exposure"]], 
                    script)

   module_run_script_UI(("summarise_exposure"), label = NULL) 
     
})

 fluidRow(column(12, uiOutput(("summarise_exposure"))))

```
  


## Set threshold <a name="run_sim"></a>
In this section, you may calculate the percent of population above specified threshold concentration.  

```{r}
#-----------------------------------------
# data_selector
#-----------------------------------------
output$data_selector_for_set_threshold <- renderUI({

  validate(need(ALL$DATA, message=FALSE))
  
  data.lst = c("", unique(names(ALL$DATA)))
  selectizeInput(("data_name_for_set_threshold"), 
                 label    = "select dataset:" , 
                 choices  = data.lst,  #unique(inputData()%>%pull(TEST)),    
                 multiple = FALSE, 
                 
                 selected = data.lst[1])  #unique(inputData()%>%pull(TEST))[1])   
})
fluidRow(column(12, uiOutput(("data_selector_for_set_threshold"))))
  
```
 
  
```{r}
 
  
script = 'calcIt<-function(dataset, params=0) {
                tabl = dataset %>% mutate(F1=F1*2)
                plot = ggplot(dataset, aes(x=TIME, y=IPRED, group=USUBJID, col=ARMA)) + 
                          geom_point() + geom_line();
      return(list(plot=plot, tabl=tabl))
} 
'
   
output$set_threshold <- renderUI({  
  
  validate(need(input$data_name_for_set_threshold, message=FALSE))
  
  ALL =  callModule(module_run_script, "set_threshold", ALL, 
                    dataset=ALL$DATA[[input$data_name_for_set_threshold]], 
                    script)

   module_run_script_UI(("set_threshold"), label = NULL) 
     
})

 fluidRow(column(12, uiOutput(("set_threshold"))))

```
  

## Plot VPC <a name="run_sim"></a>
In this section, you may overlay observed data on top of simulation data with 95% CI. 

```{r}
#-----------------------------------------
# data_selector
#-----------------------------------------
tagList(
fluidRow(column(12, uiOutput(("simdata_selector_for_VPC")))),
  
fluidRow(column(12, uiOutput(("obsdata_selector_for_VPC"))))
)

output$simdata_selector_for_VPC <- renderUI({

  validate(need(ALL$DATA, message=FALSE))
  
  data.lst = c("", unique(names(ALL$DATA)))
  selectizeInput(("simdata_name_for_VPC"), 
                 label    = "select simulated dataset:" , 
                 choices  = data.lst,  #unique(inputData()%>%pull(TEST)),    
                 multiple = FALSE, 
                 
                 selected = data.lst[1])  #unique(inputData()%>%pull(TEST))[1])   
})

output$obsdata_selector_for_VPC <- renderUI({

  validate(need(ALL$DATA, message=FALSE))
  
  data.lst = c("", unique(names(ALL$DATA)))
  selectizeInput(("obsdata_name_for_VPC"), 
                 label    = "select observed dataset:" , 
                 choices  = data.lst,  #unique(inputData()%>%pull(TEST)),    
                 multiple = FALSE, 
                 
                 selected = data.lst[1])  #unique(inputData()%>%pull(TEST))[1])   
})

  

```
 
  
```{r}
 
  
script = 'calcIt<-function(dataset, params=0) {
                tabl = dataset %>% mutate(F1=F1*2)
                plot = ggplot(dataset, aes(x=TIME, y=IPRED, group=USUBJID, col=ARMA)) + 
                          geom_point() + geom_line();
      return(list(plot=plot, tabl=tabl))
} 
'
   
output$plot_VPC <- renderUI({  
  validate(need(input$simdata_name_for_VPC, message=FALSE), 
           need(input$obsdata_name_for_VPC, message=FALSE)
  )
  
  ALL =  callModule(module_run_script, "plot_VPC", ALL, 
                    dataset=ALL$DATA[[input$simdata_name_for_VPC]], 
                    script)

   module_run_script_UI(("plot_VPC"), label = NULL) 
     
})

 fluidRow(column(12, uiOutput(("plot_VPC"))))

```
 
  
 
